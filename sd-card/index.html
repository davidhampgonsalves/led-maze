<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<html>
    <head>
      <meta charset="UTF-8">
      <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        body {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 90vh;
          background: #031a00;
          color: #00ff00;
          font-family: monospace;
          font-size: 13px;
          margin: 2em 0.5em 0;
        }

        #content-container {
          width: 470px;
        }

        #content {
          white-space-collapse: preserve;
        }

        #tune, #console {
          display: none;
        }

        #console {
          position: absolute;
          bottom: 0;
          width: 100%;
          height: 50vh;
          background: black;
          padding: 1em;
        }

        #console-toggle {
          position: absolute;
          height: 50px;
          width: 50px;
          top: 0;
          left: 0;
        }

        input[type="range"] {
          -webkit-appearance: none;
          appearance: none; /* Standard property */
          background: transparent;
          cursor: pointer;
          margin: 5px;
          width: 178px;
        }

        input[type="range"]::-webkit-slider-runnable-track {
          background: none; /* Example background color */
          height: 8px; /* Example height */
          border-radius: 4px; /* Example border-radius */
        }
        input[type="range"]::-webkit-slider-thumb {
          background: #00ff00;
          -webkit-appearance: none; /* Reset default thumb appearance */
          appearance: none;
          height: 28px; /* Example thumb size */
          width: 16px;
          margin-top: -4px; /* Adjust to center vertically on the track */
      }

        .cursor {
          display: inline-block;
          animation: blink-caret 1s step-end infinite;
        }

        #start, #about, #back {
          display: inline-block;
        }

        #start:active, #about:active, #back:active {
          margin-bottom: -10px;
        }

        #play {
          text-align: center;
          position: relative;
        }

        #play span {
          position: absolute;
          top: 140px;
          left: 180px;
          font-size: 1.2em;
        }

        input#name {
          background: none;
          border: none;
          border-bottom: solid 3px #00ff00;
          color: #00ff00;
          text-align: center;
          font-size: 18px;
          width: 50px;
          text-transform: uppercase;
          padding: 3px;
        }

        @keyframes blink-caret {
          from, to {
              opacity: 1;
          }
          50% {
              opacity: 0;
          }
        }
      </style>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    </head>
    <body>
      <div id="console-toggle"></div>
      <div id="content-container">
        <span id="content"></span>
        <span class="cursor">█</span>
      </div>

      <div id="console">
      </div>

      <div id="tune">
        <h2>debug</h2>
        <input id="accel" placeholder="acceleration" />
        <input id="friction" placeholder="friction" />
        <input id="gravity" placeholder="gravity" />
      </div>

      <script>
        const MUSIC_PATHS = ["title", "choir", "sparky", "spooky", "middling-carabana", "dark-and-light", "shannon", "fancy"];
        const SOUND_PATHS = ["sm-bounce", "bounce", "death", "portal", "slow", "count", "get-ready", "spawn", "game-end", "game-over"];

        const INTRO_CONTENT = `
     ███╗   ███╗ █████╗ ███████╗███████╗
     ████╗ ████║██╔══██╗╚══███╔╝██╔════╝
     ██╔████╔██║███████║  ███╔╝ █████╗
     ██║╚██╔╝██║██╔══██║ ███╔╝  ██╔══╝
     ██║ ╚═╝ ██║██║  ██║███████╗███████╗
     ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝╚══════╝


     TURN UP THE VOLUME + ENABLE HAPTICS

                      &

                TAP TO BEGIN`;

        const WELCOME_CONTENT = `


     ░░░╗   ░░░╗ ░░░░░╗ ░░░░░░░╗░░░░░░░╗
     ░░░░╗ ░░░░║░░╔══░░╗╚══░░░╔╝░░╔════╝
     ░░╔░░░░╔░░║░░░░░░░║  ░░░╔╝ ░░░░░╗
     ░░║╚░░╔╝░░║░░╔══░░║ ░░░╔╝  ░░╔══╝
     ░░║ ╚═╝ ░░║░░║  ░░║░░░░░░░╗░░░░░░░╗
     ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝╚══════╝


        TILT YOUR PHONE TO GUIDE YOUR

             MARBLE TO FREEDOM

<span id=start>
             ╔═══════════════╗
             ║               ║
             ║     START     ║
             ║               ║
             ╚═══════════════╝
</span>

<span id=about>
             ╔═══════════════╗
             ║               ║
             ║     ABOUT     ║
             ║               ║
             ╚═══════════════╝
</span>
<span id=settings>
             ╔═══════════════╗
             ║               ║
             ║    CONFIG     ║
             ║               ║
             ╚═══════════════╝
</span>

                                          `;

      const ABOUT_CONTENT = `


   ▒▒▒▒▒╗ ▒▒▒▒▒▒╗  ▒▒▒▒▒▒╗ ▒▒╗   ▒▒╗▒▒▒▒▒▒▒▒╗
  ▒▒╔══▒▒╗▒▒╔══▒▒╗▒▒╔═══▒▒╗▒▒║   ▒▒║╚══▒▒╔══╝
  ▒▒▒▒▒▒▒║▒▒▒▒▒▒╔╝▒▒║   ▒▒║▒▒║   ▒▒║   ▒▒║
  ▒▒╔══▒▒║▒▒╔══▒▒╗▒▒║   ▒▒║▒▒║   ▒▒║   ▒▒║
  ▒▒║  ▒▒║▒▒▒▒▒▒╔╝╚▒▒▒▒▒▒╔╝╚▒▒▒▒▒▒╔╝   ▒▒║
  ╚═╝  ╚═╝╚═════╝  ╚═════╝  ╚═════╝    ╚═╝



You are a marble, the last of your kind.

Can you escape the dungeon fast enough to be imortalized in the hall of fame or will you die trying?





    Created by: David Hamp-Gonsalves


<span id=back>
             ╔═══════════════╗
             ║               ║
             ║    ← BACK     ║
             ║               ║
             ╚═══════════════╝
</span>
                                          `;

      const SETTINGS_CONTENT = `


       ▒▒▒▒▒▒╗ ▒▒▒▒▒▒╗ ▒▒▒╗   ▒▒╗▒▒▒▒▒▒▒╗
      ▒▒╔════╝▒▒╔═══▒▒╗▒▒▒▒╗  ▒▒║▒▒╔════╝
      ▒▒║     ▒▒║   ▒▒║▒▒╔▒▒╗ ▒▒║▒▒▒▒▒╗
      ▒▒║     ▒▒║   ▒▒║▒▒║╚▒▒╗▒▒║▒▒╔══╝
      ╚▒▒▒▒▒▒╗╚▒▒▒▒▒▒╔╝▒▒║ ╚▒▒▒▒║▒▒║
      ╚═════╝ ╚═════╝ ╚═╝  ╚═══╝╚═╝




              ** BRIGHTNESS **
          ╔════════════════════════╗
          ║<input type="range" id="brightness" value=30 />║
          ║                        ║
          ╚════════════════════════╝
</span>





<span id=back>
              ╔═══════════════╗
              ║               ║
              ║    ← BACK     ║
              ║               ║
              ╚═══════════════╝
</span>
                                          `;

const PLAY_CONTENT = `

<div id=play>
╔═══════════════════════════════════╗
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                <span>+</span>                  ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
╚═══════════════════════════════════╝
</div>







                                          `;

const HIGH_SCORE_CONTENT = `


         ▒▒╗  ▒▒╗▒▒╗ ▒▒▒▒▒▒╗ ▒▒╗  ▒▒╗
         ▒▒║  ▒▒║▒▒║▒▒╔════╝ ▒▒║  ▒▒║
         ▒▒▒▒▒▒▒║▒▒║▒▒║  ▒▒▒╗▒▒▒▒▒▒▒║
         ▒▒╔══▒▒║▒▒║▒▒║   ▒▒║▒▒╔══▒▒║
         ▒▒║  ▒▒║▒▒║╚▒▒▒▒▒▒╔╝▒▒║  ▒▒║
         ╚═╝  ╚═╝╚═╝ ╚═════╝ ╚═╝  ╚═╝


   ▒▒▒▒▒▒▒╗ ▒▒▒▒▒▒╗ ▒▒▒▒▒▒╗ ▒▒▒▒▒▒╗ ▒▒▒▒▒▒▒╗
   ▒▒╔════╝▒▒╔════╝▒▒╔═══▒▒╗▒▒╔══▒▒╗▒▒╔════╝
   ▒▒▒▒▒▒▒╗▒▒║     ▒▒║   ▒▒║▒▒▒▒▒▒╔╝▒▒▒▒▒╗
   ╚════▒▒║▒▒║     ▒▒║   ▒▒║▒▒╔══▒▒╗▒▒╔══╝
   ▒▒▒▒▒▒▒║╚▒▒▒▒▒▒╗╚▒▒▒▒▒▒╔╝▒▒║  ▒▒║▒▒▒▒▒▒▒╗
   ╚══════╝ ╚═════╝ ╚═════╝ ╚═╝  ╚═╝╚══════╝



                    <input maxLength=3 id=name />


<span id=submit>
               ╔═══════════════╗
               ║               ║
               ║     Enter     ║
               ║               ║
               ╚═══════════════╝
</span>


                                          `;

const DEATH_CONTENT = `




            ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
         ▒▒▒▒▒▒          ▒▒▒▒▒▒
       ▒▒▒▒                  ▒▒▒▒
     ▒▒▒▒                      ▒▒▒▒
    ▒▒▒                          ▒▒▒
   ▒▒▒                            ▒▒▒
  ▒▒▒       ▒▒▒▒        ▒▒▒▒       ▒▒▒
 ▒▒▒       ▒▒▒▒▒▒      ▒▒▒▒▒▒▒      ▒▒▒
 ▒▒      ▒▒▒▒▒▒▒▒▒     ▒▒▒▒▒▒▒▒      ▒▒
▒▒▒      ▒▒▒▒▒▒▒▒      ▒▒▒▒▒▒▒▒      ▒▒▒
▒▒▒        ▒▒▒▒▒        ▒▒▒▒▒        ▒▒▒
 ▒▒                ▒▒                ▒▒
 ▒▒▒              ▒▒▒▒              ▒▒▒
  ▒▒▒                              ▒▒▒
   ▒▒▒▒                          ▒▒▒
     ▒▒▒▒▒                    ▒▒▒▒▒
        ▒▒      ▒      ▒      ▒▒
        ▒▒      ▒      ▒      ▒▒
        ▒▒▒▒    ▒▒    ▒▒    ▒▒▒▒
          ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒



                                          `;
const WIN_CONTENT = `




                TODO: WIN ANIMATION



                                          `;
      </script>

      <script>
        /**
         * ios-haptics v0.1.0
         * tijn.dev
         * ▒license MIT
         */
        function haptic() {
          try {
            if (navigator.vibrate) {
              navigator.vibrate(50)
              return
            }

            const labelEl = document.createElement('label')
            labelEl.ariaHidden = 'true'
            labelEl.style.display = 'none'

            const inputEl = document.createElement('input')
            inputEl.type = 'checkbox'
            inputEl.setAttribute('switch', '')
            labelEl.appendChild(inputEl)

            document.head.appendChild(labelEl)
            labelEl.click()
            document.head.removeChild(labelEl)
          }
          catch {
            // do nothing
          }
        };
      </script>
      <script type="module">
        const contentEl = document.querySelector("#content");

        const FRAME_RATE = 100;
        let displayCount = 0;
        let currentPage = null;
        function display(page, content, initFn, options={}) {
          currentPage = page;
          displayCount++;
          const displayId = displayCount;

          options = { flicker: false, frameDelay: 3, ...options };
          let start = Date.now();
          const animate = () => {
            requestAnimationFrame(() => {
              if(displayId != displayCount) return; // another display animation has started so abort

              let index = Math.floor((Date.now() - start) / options.frameDelay);
              let curContent = content.slice(0, index);
              if(options.flicker && (index < 150 || (index > 160 && index < 180) || (index > 190 && index < 270) || (index > 290 && index < 360)))
                curContent = curContent.replaceAll("█", "&nbsp;");
              contentEl.innerHTML = curContent;

              if(index >= content.length + (options.flicker ? 200 : 0)) {
                contentEl.innerHTML = content
                initFn();
              } else
                animate();
            });
          }

          animate();
        }

        function vibrate() {
          // switchEl.checked = !switchEl.checked;
          haptic();
        }
        function multiVibrate(count) {
          for(let i=0 ; i < count ; i++)
            window.setTimeout(vibrate, i * 100);
        }

        let wakeLock = null;
        async function ensureDevicePermissions() {
          if (typeof DeviceOrientationEvent.requestPermission !== "function") return;

          await DeviceOrientationEvent.requestPermission().then((state) => {
            if (state === "granted") return;

            console.error("You must grant permission for sensor data to play");
          });
        };

        async function requestWakeLock() {
          try {
            wakeLock = await navigator.wakeLock.request("screen");
          } catch (err) {
            alert(`${err.name}, ${err.message}`);
          }
        }

        const gateway = `wss://maze.davidhampgonsalves.com:9000/ws`;
        let websocket;
        function initWebSocket() {
          console.log('Trying to open a WebSocket connection...');
          websocket = new WebSocket(gateway);
          websocket.onopen    = onOpen;
          websocket.onclose   = onClose;
          websocket.onmessage = onMessage;
        }
        function onOpen(event) {
          console.log('Connection opened');
        }
        function onClose(event) {
          console.log('Connection closed');
          setTimeout(initWebSocket, 500);
        }
        function onMessage(event) {
          console.log("onMessage:", event.data)

          const { type, url, score } = JSON.parse(event.data);
          if(type == "PLAY_SONG")
            playSong(url);
          else if(type == "STOP_SONG")
            stopSong();
          else if(type == "PLAY_SOUND") {
            playSound(url);
            if(url.endsWith("bounce.wav")) vibrate();
            if(url.endsWith("death.wav")) multiVibrate(3);
          } else if(type == "HIGH_SCORE") {
            highScore(score);
            playSound("sounds/high-score.wav");
          } else if(type == "WELCOME" && currentPage != "WELCOME") {
            welcome();
          }
        }

        function initConsole() {
          const cLog = console.log;

          function log(...args) {
            const consoleEl = document.querySelector("#console");
            const el = document.createElement('div');
            el.innerText = args.join(", ");
            consoleEl.prepend(el);

            cLog(...args);
          }

          console.log = log;
          console.error = log;

          const consoleEl = document.querySelector("#console");
          document.querySelector("#console-toggle").addEventListener("click", () => {
            vibrate();
            if(consoleEl.style.display == "block")
              consoleEl.style.display = "none";
            else
              consoleEl.style.display = "block";
          })
        }

        let lastSendTime = 0;
        let posEl = null;
        function handleOrientationEvent(event) {
          const { beta, gamma } = event;
          if(beta == null) {
            console.log("beta not set");
            return;
          }

          const now = Date.now();
          if (now - lastSendTime >= 250) {
            lastSendTime = now;
            console.log("pos:" + event.beta.toFixed(2) + "," + event.gamma.toFixed(2));
            websocket.send("pos:" + event.beta.toFixed(2) + "," + event.gamma.toFixed(2));

            if(!posEl) posEl = document.querySelector("#play span");
            posEl.style.top = 140 + (beta / 90 * 95) + "px";
            posEl.style.left = 180 + (gamma / 90 * 115) + "px";
          }
        }

        async function start(e) {
          vibrate();
          await ensureDevicePermissions();
          await requestWakeLock();
          play();

          window.addEventListener('deviceorientation', handleOrientationEvent);
        }

        function handleSettingChange() {
          const value = event.target.value.trim();
          if(value == "") return;

          console.log("sending" + event.target.id + ":" + value);
          websocket.send(event.target.id + ":" + value);

        }

        document.addEventListener("visibilitychange", async () => {
          if (wakeLock !== null && document.visibilityState === "visible") {
            wakeLock = await navigator.wakeLock.request("screen");
          }
        });

        document.querySelectorAll("#debug input").forEach(e => e.addEventListener("blur", handleSettingChange));

        function welcome() {
          vibrate();
          document.querySelector("body").removeEventListener("click", welcome);
          playSong("music/title.wav", true);
          display("WELCOME", WELCOME_CONTENT, () => {
            document.querySelector("#start").addEventListener("click", start);
            document.querySelector("#about").addEventListener("click", about);
            document.querySelector("#settings").addEventListener("click", settings);
          });
        }

        function about() {
          vibrate();
          display("ABOUT", ABOUT_CONTENT, () => {
            document.querySelector("#back").addEventListener("click", welcome);
          });
        }

        function settings() {
          vibrate();
          display("SETTINGS", SETTINGS_CONTENT, () => {
            document.querySelector("#back").addEventListener("click", welcome);
            document.querySelector("#brightness").addEventListener("input", (event) => {
              const brightness =  event.target.value;
              console.log("sending brightness " + brightness);
              websocket.send(`brightness:${brightness}`);
            });
          });
        }

        function intro() {
          document.querySelector("body").addEventListener("click", welcome);
          display("INTRO", INTRO_CONTENT, () => {}, { flicker: true, frameDelay: 8 });
        }

        function death() {
          window.removeEventListener('deviceorientation', handleOrientationEvent);

          display("DEATH", DEATH_CONTENT, () => {}, { flicker: true, frameDelay: 8 });

          window.setTimeout(welcome, 3000);
        }

        function win() {
          window.removeEventListener('deviceorientation', handleOrientationEvent);
          display("WIN", WIN_CONTENT, () => {}, { flicker: true, frameDelay: 8 });

          window.setTimeout(welcome, 3000);
        }

        function highScore(score) {
          multiVibrate(2);
          display("HIGH_SCORE", HIGH_SCORE_CONTENT, () => {
            document.querySelector("#submit").addEventListener("click", (e) => {
              vibrate();
              const inputEl = document.querySelector("input");
              const value = inputEl.value.trim();
              if(value !== "") {
                websocket.send("highscore:" + score + "," + value);
                welcome();
                return;
              }

              inputEl.style.border = "solid 2px red";
            });
          });
        }

        function play() {
          vibrate();
          stopSong();
          playSound("sounds/get-ready.wav");
          websocket.send("start:1");
          display("PLAY", PLAY_CONTENT, () => {
            vibrate();
          });
        }

        let song = null;
        function playSong(url, doNotRestart=false) {
          url = "https://raw.githubusercontent.com/davidhampgonsalves/led-maze/main/" + url;
          if(doNotRestart && song?.buffer == soundBuffers[url]) return;
          if(song) song.disconnect();

          song = audioContext.createBufferSource();
          song.buffer = soundBuffers[url];
          song.connect(audioContext.destination);
          song.loop = true;
          song.start(0);
        }


        function playSound(url) {
          const source = audioContext.createBufferSource();
          url = "https://raw.githubusercontent.com/davidhampgonsalves/led-maze/main/" + url;
          source.buffer = soundBuffers[url];
          source.connect(audioContext.destination);
          source.start(0);

          source.onended = () => {
              source.disconnect();
          };
        }

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const soundBuffers = {};
        function preloadSounds() {
          MUSIC_PATHS.forEach(async path => {
            const url = "https://raw.githubusercontent.com/davidhampgonsalves/led-maze/main/music/" + path + ".wav";
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            soundBuffers[url] = await audioContext.decodeAudioData(arrayBuffer);
          })
          SOUND_PATHS.forEach(async path => {
            const url = "https://raw.githubusercontent.com/davidhampgonsalves/led-maze/main/sounds/" + path + ".wav";
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            soundBuffers[url] = await audioContext.decodeAudioData(arrayBuffer);
          })
        }

        function stopSong() {
          // if(song) song.pause();
          if(song) song.disconnect();
         }


        preloadSounds();
        initWebSocket();
        intro();
        initConsole();
      </script>
      <audio id="music" src="https://raw.githubusercontent.com/davidhampgonsalves/led-maze/main/sounds/count.wav"></audio>
    </body>
    </html>
    <script>