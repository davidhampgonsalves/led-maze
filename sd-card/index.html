<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<html>
    <head>
      <style>
        body {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 90vh;
          background: #031a00;
          color: green;
          font-family: monospace;
          font-size: 15px;
          text-shadow: 0 0 0.04em #00dc58;
          margin: 2em 0.5em 0;
        }

        #content-container {
          width: 470px;
        }

        #content {
          white-space-collapse: preserve;
        }

        body::after {
          pointer-events: none;
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: repeating-linear-gradient(0deg, rgba(0,0,0, 0.5), rgba(0, 0, 0, 0.5) 1px, transparent 0px, transparent 2px)
        }

        #tune, #console {
          display: none;
        }

        #console {
          position: absolute;
          bottom: 0;
          width: 100%;
          height: 50vh;
          background: black;
          padding: 1em;
        }

        #console-toggle {
          position: absolute;
          height: 50px;
          width: 50px;
          top: 0;
          left: 0;
        }

        .cursor {
          display: inline-block;
          animation: blink-caret 1s step-end infinite;
        }

        #start, #about, #back {
          display: inline-block;
        }

        #start:active, #about:active, #back:active {
          margin-bottom: -10px;
        }

        #play {
          text-align: center;
          position: relative;
        }

        #play span {
          position: absolute;
          top: 185px;
          left: 228px;
          font-size: 1.2em;
        }

        @keyframes blink-caret {
          from, to {
              opacity: 1;
          }
          50% {
              opacity: 0;
          }
        }
      </style>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    </head>
    <body>
      <div id="console-toggle"></div>
      <div id="content-container">
        <span id="content"></span>
        <span class="cursor">█</span>
      </div>

      <div id="console">
        # Console
      </div>

      <div id="tune">
        <h2>debug</h2>
        <input id="accel" placeholder="acceleration" />
        <input id="friction" placeholder="friction" />
        <input id="gravity" placeholder="gravity" />
      </div>

      <script>
        const INTRO_CONTENT = `
     ███╗   ███╗ █████╗ ███████╗███████╗
     ████╗ ████║██╔══██╗╚══███╔╝██╔════╝
     ██╔████╔██║███████║  ███╔╝ █████╗
     ██║╚██╔╝██║██╔══██║ ███╔╝  ██╔══╝
     ██║ ╚═╝ ██║██║  ██║███████╗███████╗
     ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝╚══════╝


               TAP TO BEGIN...`;

        const WELCOME_CONTENT = `


     ░░░╗   ░░░╗ ░░░░░╗ ░░░░░░░╗░░░░░░░╗
     ░░░░╗ ░░░░║░░╔══░░╗╚══░░░╔╝░░╔════╝
     ░░╔░░░░╔░░║░░░░░░░║  ░░░╔╝ ░░░░░╗
     ░░║╚░░╔╝░░║░░╔══░░║ ░░░╔╝  ░░╔══╝
     ░░║ ╚═╝ ░░║░░║  ░░║░░░░░░░╗░░░░░░░╗
     ╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝╚══════╝



<span id=start>
            ╔═══════════════╗
            ║               ║
            ║     START     ║
            ║               ║
            ╚═══════════════╝
</span>

<span id=about>
            ╔═══════════════╗
            ║               ║
            ║     ABOUT     ║
            ║               ║
            ╚═══════════════╝
</span>

                                          `;

      const ABOUT_CONTENT = `


  ▒▒▒▒▒╗ ▒▒▒▒▒▒╗  ▒▒▒▒▒▒╗ ▒▒╗   ▒▒╗▒▒▒▒▒▒▒▒╗
 ▒▒╔══▒▒╗▒▒╔══▒▒╗▒▒╔═══▒▒╗▒▒║   ▒▒║╚══▒▒╔══╝
 ▒▒▒▒▒▒▒║▒▒▒▒▒▒╔╝▒▒║   ▒▒║▒▒║   ▒▒║   ▒▒║
 ▒▒╔══▒▒║▒▒╔══▒▒╗▒▒║   ▒▒║▒▒║   ▒▒║   ▒▒║
 ▒▒║  ▒▒║▒▒▒▒▒▒╔╝╚▒▒▒▒▒▒╔╝╚▒▒▒▒▒▒╔╝   ▒▒║
 ╚═╝  ╚═╝╚═════╝  ╚═════╝  ╚═════╝    ╚═╝



You are a marble, the last of your kind.

Can you escape the dungeon fast enough to be imortalized in the hall of fame or will you die trying?





        Created by: David Hamp-Gonsalves


<span id=back>
            ╔═══════════════╗
            ║               ║
            ║    ← BACK     ║
            ║               ║
            ╚═══════════════╝
</span>
                                          `;


const PLAY_CONTENT = `

<div id=play>
╔═══════════════════════════════════╗
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                <span>+</span>                  ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
║                                   ║
╚═══════════════════════════════════╝
</div>







                                          `;
      </script>

      <script type="module">
        const contentEl = document.querySelector("#content");

        const FRAME_RATE = 100;
        let displayCount = 0;
        function display(content, initFn, options={}) {
          displayCount++;
          const displayId = displayCount;

          options = { flicker: false, frameDelay: 3, ...options };
          let start = Date.now();
          const animate = () => {
            requestAnimationFrame(() => {
              if(displayId != displayCount) return; // another display animation has started so abort

              let index = Math.floor((Date.now() - start) / options.frameDelay);
              let curContent = content.slice(0, index);
              if(options.flicker && (index < 150 || (index > 160 && index < 180) || (index > 190 && index < 270) || (index > 290 && index < 360)))
                curContent = curContent.replaceAll("█", "&nbsp;");
              contentEl.innerHTML = curContent;

              if(index >= content.length + (options.flicker ? 200 : 0)) {
                contentEl.innerHTML = content
                initFn();
              } else
                animate();
            });
          }

          animate();
        }

        let wakeLock = null;
        async function ensureDevicePermissions() {
          if (typeof DeviceOrientationEvent.requestPermission !== "function") return;

          await DeviceOrientationEvent.requestPermission().then((state) => {
            if (state === "granted") return;

            console.error("You must grant permission for sensor data to play");
          });
        };

        async function requestWakeLock() {
          try {
            wakeLock = await navigator.wakeLock.request("screen");
          } catch (err) {
            alert(`${err.name}, ${err.message}`);
          }
        }

        const gateway = `wss://maze.davidhampgonsalves.com:9000/ws`;
        let websocket;
        function initWebSocket() {
          console.log('Trying to open a WebSocket connection...');
          websocket = new WebSocket(gateway);
          websocket.onopen    = onOpen;
          websocket.onclose   = onClose;
          websocket.onmessage = onMessage;
        }
        function onOpen(event) {
          console.log('Connection opened');
        }
        function onClose(event) {
          console.log('Connection closed');
          setTimeout(initWebSocket, 500);
        }
        function onMessage(event) {
          console.log("onMessage:", event.data)

          const { type, url } = JSON.parse(event.data);
          if(type == "PLAY_SONG")
            playSong(url);
          else if(type == "PLAY_SOUND")
            playSound(url);
        }

        function log(...args) {
          const consoleEl = document.querySelector("#console");
          const el = document.createElement('div');
          el.innerText = args.join(", ");
          consoleEl.appendChild(el);
        }
        function initConsole() {
          console.log = log;
          console.error = log;

          const consoleEl = document.querySelector("#console");
          document.querySelector("#console-toggle").addEventListener("click", () => {
            if(consoleEl.style.display == "block")
              consoleEl.style.display = "none";
            else
              consoleEl.style.display = "block";
          })
        }

        let lastSendTime = 0;
        function handleOrientationEvent(event, posEl) {
          if(event.beta == null) {
            console.log("beta not set");
            return;
          }

          console.log(event.beta, event.gamma);
          posEl.style.top = 185 + (event.beta / 1);
          posEl.style.left = 228 + (event.gamma / 1);

          const now = Date.now();
          if (now - lastSendTime >= 300) {
            lastSendTime = now;
            console.log("pos:" + event.beta.toFixed(2) + "," + event.gamma.toFixed(2));
            websocket.send("pos:" + event.beta.toFixed(2) + "," + event.gamma.toFixed(2));
          }
        }

        async function start(e) {
          await ensureDevicePermissions();
          await requestWakeLock();
          play();

          const posEl = document.querySelector("#play span");
          window.addEventListener('deviceorientation', (e) => handleOrientationEvent(e, posEl));

          initWebSocket();

          // document.querySelector("#debug").style.visibility = 'visible'
        }

        function handleSettingChange() {
          const value = event.target.value.trim();
          if(value == "") return;

          console.log("sending" + event.target.id + ":" + value);
          websocket.send(event.target.id + ":" + value);

        }

        document.addEventListener("visibilitychange", async () => {
          if (wakeLock !== null && document.visibilityState === "visible") {
            wakeLock = await navigator.wakeLock.request("screen");
          }
        });

        document.querySelectorAll("#debug input").forEach(e => e.addEventListener("blur", handleSettingChange));

        function welcome() {
          document.querySelector("body").removeEventListener("click", welcome);
          playSong("music/title.wav", true);
          display(WELCOME_CONTENT, () => {
            document.querySelector("#start").addEventListener("click", start);
            document.querySelector("#about").addEventListener("click", about);
          });
        }

        function about() {
          display(ABOUT_CONTENT, () => {
            document.querySelector("#back").addEventListener("click", welcome);
          });
        }

        function intro() {
          document.querySelector("body").addEventListener("click", welcome);
          display(INTRO_CONTENT, () => {}, { flicker: true, frameDelay: 6 });
        }

        function play() {
          stopSong();
          playSound("sounds/get-ready.wav");
          display(PLAY_CONTENT, () => {});
        }

        let song = null;
        function playSong(url, doNotRestart=false) {
          url = "https://raw.githubusercontent.com/davidhampgonsalves/led-maze/main/" + url;
          if(doNotRestart && song?.currentSrc == url) return;
          song = new Audio(url);
          if(song) song.pause();
          song.loop = true;
          song.addEventListener("canplaythrough", (event) => {
            song.play();
          });
        }

        function playSound(url) {
          url = "https://raw.githubusercontent.com/davidhampgonsalves/led-maze/main/" + url;
          const sound = new Audio(url);
          sound.addEventListener("canplaythrough", (event) => {
            sound.play();
          });
          return sound;
        }

        function stopSong() {
          if(song) song.pause();
        }

        intro();
        // initConsole();
      </script>
    </body>
    </html>
    <script>